name: Deploy to Shopify Stores

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        store: [store1, store2]
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Shopify CLI
        run: npm install -g @shopify/cli @shopify/theme
      
      - name: Build theme for ${{ matrix.store }}
        run: npm run build:${{ matrix.store }}
      
      - name: Deploy to ${{ matrix.store }}
        env:
          SHOPIFY_FLAG_STORE: ${{ matrix.store == 'store1' && secrets.STORE1_SHOPIFY_FLAG_STORE || secrets.STORE2_SHOPIFY_FLAG_STORE }}
          SHOPIFY_CLI_THEME_TOKEN: ${{ matrix.store == 'store1' && secrets.STORE1_SHOPIFY_CLI_THEME_TOKEN || secrets.STORE2_SHOPIFY_CLI_THEME_TOKEN }}
        run: |
          cd build/${{ matrix.store }}
          THEME_NAME="GitHub-Deploy-$(date +%Y%m%d-%H%M%S)"
          shopify theme push --unpublished --theme="Shoplc-github-demo" --path=. --json --force
      
      - name: Deployment summary
        run: |
          echo "âœ… Successfully deployed to ${{ matrix.store }}"
          if [ "${{ matrix.store }}" == "store1" ]; then
            echo "Store: tapan-sain.myshopify.com"
          else
            echo "Store: tapan-sain-bv.myshopify.com"
          fi