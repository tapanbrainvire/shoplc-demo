name: Deploy to Shopify Stores

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        store: [store1, store2, store3, store4]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Shopify CLI
        run: npm install -g @shopify/cli @shopify/theme
      
      - name: Build theme for ${{ matrix.store }}
        run: |
          mkdir -p build/${{ matrix.store }}
          cp -r shared/* build/${{ matrix.store }}/
          
          if [ -d "stores/${{ matrix.store }}/overrides" ]; then
            cp -r stores/${{ matrix.store }}/overrides/* build/${{ matrix.store }}/
          fi

          if [ -d "stores/${{ matrix.store }}/config" ]; then
            mkdir -p build/${{ matrix.store }}/config
            cp -r stores/${{ matrix.store }}/config/* build/${{ matrix.store }}/config/
          fi
      
      - name: Deploy to ${{ matrix.store }}
        env:
          SHOPIFY_FLAG_STORE: ${{ secrets[format('STORE{0}_SHOPIFY_FLAG_STORE', matrix.store == 'store1' && '1' || matrix.store == 'store2' && '2' || matrix.store == 'store3' && '3' || '4')] }}
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets[format('STORE{0}_SHOPIFY_CLI_THEME_TOKEN', matrix.store == 'store1' && '1' || matrix.store == 'store2' && '2' || matrix.store == 'store3' && '3' || '4')] }}
        run: |
          cd build/${{ matrix.store }}
          shopify theme push --unpublished --json
